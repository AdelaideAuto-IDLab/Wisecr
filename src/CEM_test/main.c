/*
 * \file   main.c
 *
 * \brief  Main routine for the bootloader for FR5969
 *
 */
/* --COPYRIGHT--,BSD
 * Copyright (c) 2012, Texas Instruments Incorporated
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * *  Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 *
 * *  Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * *  Neither the name of Texas Instruments Incorporated nor the names of
 *    its contributors may be used to endorse or promote products derived
 *    from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
 * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * --/COPYRIGHT--*/


#include <msp430.h>
#include <stdint.h>
#include "TI_MSPBoot_Common.h"
#include "TI_MSPBoot_CI.h"
#include "TI_MSPBoot_MI.h"
#include "TI_MSPBoot_AppMgr.h"
#include "wisp-base.h"
#include <stdbool.h>


#define WRITE_SIZE 512

static uint16_t* BASE_ADDRESS = (uint16_t*)0x10000;

uint16_t rawV;
uint16_t miliVolt_start;
uint16_t miliVolt_finish;
extern uint8_t  usrBank [USRBANK_SIZE];
extern WISP_dataStructInterface_t wispData;

//
//  Local function prototypes
//
static void HW_init(void);
static void MPU_init(void);

extern void CopyWispISRs(void);
extern inline void TTIEM(uint16_t time);
extern inline void EnterPAM(uint8_t sleepT, uint8_t activeT);
extern inline void ExitPAM(void);



void ledBlinks (uint8_t count, uint16_t duration) {

    while(count--) {
        // Stay on for ~1ms, then wait for specified duration
        BITSET(PLED1OUT,PIN_LED1);
        Timer_LooseDelay(32);
        BITCLR(PLED1OUT,PIN_LED1);
        Timer_LooseDelay(duration);
    }
    return;
}

void FRAMPrep(void)
{
  unsigned int i=0;

  for ( i= 0; i< WRITE_SIZE; i++)
  {
      BASE_ADDRESS[i] = 0x00;
  }
}

const uint8_t msg[1536] = {0xaf,0x11,0xad,0x81,0x36,0x85,0x03,0xc3,0x5e,0x47,0x1f,0x18,0x69,0x79,0x08,0x60,0x94,0x8a,0x92,0x4d,0x66,0xaa,0x50,0x4d,0x94,0x99,0x64,0x22,0xa3,0x83,0xf3,0xd3,0x0d,0x5f,0x59,0xee,0xcb,0x09,0x8e,0x14,0x86,0xf4,0x96,0x0a,0xdf,0xdb,0x73,0x2b,0x28,0x9f,0xc2,0x4b,0xb8,0x2c,0x55,0xea,0x61,0x12,0x51,0xb4,0xf0,0xd3,0x68,0x9d,0x19,0xc4,0x49,0x2f,0x9b,0x9c,0x7e,0x4e,0x03,0xe0,0x3b,0xa2,0x04,0x0a,0x6a,0x55,0xef,0x5e,0x67,0x7e,0xd3,0xb8,0x1a,0x9d,0x67,0x06,0x8e,0x41,0x24,0x28,0xf7,0x3d,0x88,0x57,0x5d,0xc8,0xb7,0xdb,0x7a,0x64,0xf4,0xc4,0xd4,0xd3,0x0c,0x63,0x39,0x27,0xeb,0xeb,0xc5,0x1a,0x05,0xa6,0xf1,0x94,0x85,0xf6,0x6d,0xae,0x87,0xf6,0xf5,0x98,0x4c,0x60,0xaa,0xf1,0xc8,0xf2,0x71,0xe4,0xa5,0x4f,0x49,0x42,0x4c,0x13,0x93,0x37,0xf7,0x6b,0x02,0xf2,0xc4,0x17,0x67,0x5a,0x09,0x56,0x36,0x82,0x12,0x3d,0xee,0xe8,0xea,0xab,0x29,0xca,0x21,0xd5,0x82,0xc8,0x2f,0x87,0x1e,0x1b,0xb7,0xdf,0x07,0xdb,0x8d,0xab,0xd1,0xe2,0x33,0x0d,0x3c,0x86,0xdb,0x61,0x4e,0x9e,0xd3,0xec,0x08,0xfc,0x6e,0xb4,0xaf,0xff,0x0f,0x22,0x49,0x1b,0x2e,0x1b,0xd7,0x25,0x77,0xee,0x8b,0x04,0xdc,0x29,0x10,0xba,0xf4,0x30,0x70,0xc5,0xe0,0xf3,0xed,0x7b,0x02,0x99,0xae,0x15,0x9a,0x5b,0x91,0x78,0x4b,0xf2,0xb0,0xd3,0x61,0x46,0x57,0x23,0x3c,0x7d,0x00,0x67,0xfe,0xdb,0xe3,0xe2,0x9a,0x47,0x39,0x2f,0x64,0x76,0xb9,0x5d,0xd7,0x18,0xc2,0x75,0x19,0x12,0x10,0x5a,0x26,0xac,0xa7,0x7b,0x81,0x3d,0xc3,0xed,0xfc,0x46,0x3e,0xdc,0x82,0x8c,0x86,0x57,0xf1,0xdc,0xe4,0xf4,0x57,0x7f,0xe1,0x28,0xab,0x02,0x38,0x9c,0x13,0x87,0x53,0xc6,0x75,0x65,0xf4,0x9d,0xf2,0xfc,0xb5,0x70,0xd5,0xa1,0xea,0xaf,0xbd,0xb7,0x82,0xea,0xaa,0xa0,0x92,0x2d,0x92,0x95,0x6f,0xd4,0xf0,0x2f,0x02,0x72,0x5e,0xe1,0x33,0xa6,0x09,0x27,0xc5,0x29,0xf8,0x0c,0x34,0x76,0xa2,0xe9,0x46,0xf7,0xaf,0xf5,0xf4,0x57,0x16,0x71,0x26,0xcc,0x03,0x8f,0x20,0x11,0x80,0xa0,0x80,0xb2,0x22,0x15,0xd7,0x21,0x93,0x8b,0x73,0x63,0x02,0xfd,0xfa,0x31,0x93,0xbc,0x60,0x69,0x02,0x97,0x37,0x07,0x1a,0x15,0xa5,0xdc,0x8c,0x3a,0xdc,0x77,0x34,0x6a,0x8a,0x27,0xb2,0xaf,0x58,0x51,0xa7,0xa9,0x96,0xfc,0xad,0x69,0x95,0x74,0x3b,0x89,0x77,0x40,0x8b,0xad,0xfb,0xab,0x39,0xcf,0x6a,0x04,0x12,0xa7,0xe3,0x14,0xe9,0xa1,0x00,0xb9,0xfc,0x26,0xdd,0x5b,0x2d,0x8e,0xac,0x7a,0x15,0xd3,0x04,0x15,0xd5,0x9c,0xc9,0x89,0x81,0x49,0x0c,0xec,0x77,0xcd,0x81,0x38,0x58,0x53,0xb2,0x51,0xeb,0xd1,0xc0,0x7e,0x83,0x5b,0x8f,0xe9,0x1e,0x35,0xcb,0x74,0xb3,0x3c,0xba,0xf8,0x16,0x4c,0x28,0x3d,0x0b,0x0d,0x9c,0x4b,0x10,0x4c,0x2b,0x10,0xc2,0x99,0x26,0x66,0x42,0xb4,0x0f,0x7f,0xba,0xc7,0xa5,0x93,0x04,0xe2,0xbe,0x93,0xd0,0x12,0xfe,0x0b,0x6d,0x4e,0x3e,0x2d,0xed,0x11,0x79,0x53,0xeb,0x86,0x45,0xc9,0x7b,0x4c,0x8b,0xb8,0x31,0x2b,0x60,0x7c,0xc0,0xca,0xa2,0x29,0x52,0x56,0x36,0x72,0xde,0x1b,0x79,0x97,0xbb,0x58,0x5e,0xf5,0x72,0xd4,0xb9,0x5c,0x07,0xb3,0xb3,0x81,0xeb,0x3d,0x93,0x01,0x7d,0x43,0x91,0xf5,0x82,0x54,0x2b,0xfe,0xfb,0x16,0x4d,0x3a,0xd4,0xa9,0x49,0xe1,0x37,0x56,0x52,0xdb,0x98,0x71,0x52,0x8d,0x77,0x9f,0x49,0x43,0x70,0x8d,0x81,0x32,0x0c,0x74,0xcf,0x26,0x95,0x60,0x1e,0x8f,0x77,0x90,0x22,0x5c,0xf7,0xac,0x20,0x1b,0xae,0xbb,0x08,0xbf,0x0c,0xed,0x34,0xf0,0xa7,0x63,0xea,0x69,0xc2,0x20,0x19,0x35,0x81,0x69,0x80,0x7d,0xa2,0x54,0x91,0x67,0x0a,0xb9,0xc7,0x53,0x53,0x22,0x35,0xd9,0xa8,0xd1,0x46,0xf4,0x4a,0x01,0x47,0x9e,0xad,0x4e,0x53,0xb9,0xd5,0x3b,0x61,0x72,0x72,0x5f,0xd4,0xa3,0x62,0xa9,0x82,0x9e,0xb3,0xcd,0x73,0xe1,0x41,0x25,0x66,0x97,0xfd,0x04,0xb3,0x36,0x5c,0x1b,0x25,0xa9,0x2e,0xe9,0x74,0xd4,0xa5,0x93,0xc0,0x69,0x86,0xe0,0xf2,0xcf,0x33,0xaf,0x38,0x11,0x5e,0x73,0x60,0x80,0x3d,0x68,0xd4,0x00,0x79,0xf8,0x76,0x5a,0xfa,0x0d,0x77,0x9a,0xab,0x8b,0xdd,0x07,0x9e,0xed,0x8f,0x57,0x66,0xed,0xe9,0x8c,0x32,0x1a,0x26,0x31,0xdc,0x72,0xa2,0x74,0xb1,0xaa,0x1e,0x44,0x8b,0xb4,0x77,0xd5,0x1b,0xee,0x5b,0x96,0x54,0xbf,0xbc,0x0f,0x95,0x68,0xb8,0xef,0xc7,0xb5,0x83,0x9c,0x2e,0xf2,0xde,0x18,0xfc,0x71,0x58,0x5e,0x17,0x42,0xda,0x81,0x64,0x55,0xfe,0x5f,0xc4,0xa7,0xaa,0x25,0xab,0xbc,0xc3,0xa0,0xd0,0xae,0xeb,0x5a,0x1b,0x63,0xf6,0x51,0xb6,0x07,0x79,0x56,0xc6,0xae,0x67,0x67,0xb1,0x63,0x92,0xd6,0x0b,0x88,0x2a,0x48,0x6f,0xad,0x1c,0x16,0xf6,0xdf,0x0c,0x1f,0xcb,0x82,0xb3,0x29,0xbf,0x20,0xf6,0x43,0x5f,0x76,0xba,0x7c,0xc9,0x3b,0xb9,0x07,0xae,0xca,0xa5,0xf9,0xcd,0x73,0x54,0x19,0x1d,0x41,0x2e,0xcb,0xa0,0xfb,0x83,0x4b,0x0f,0x73,0x87,0x67,0xfe,0x42,0xe5,0x03,0x74,0x4b,0xa5,0x38,0x5c,0x42,0x78,0xc2,0x07,0x47,0x9a,0x70,0x33,0x94,0xe8,0x33,0x32,0xa3,0xca,0xa7,0x80,0xfc,0x91,0x66,0x4c,0x27,0xb2,0x1c,0x00,0x25,0xf8,0x54,0x62,0x67,0x52,0xe3,0x7e,0xe7,0x81,0xe1,0x90,0x5d,0xf3,0x9f,0x97,0x2d,0xc8,0xdb,0x3a,0x9f,0xde,0x92,0xe3,0x42,0x18,0xa0,0xf2,0xb6,0x34,0x7f,0xf9,0x01,0x2c,0xe5,0xb1,0x46,0x80,0x91,0x9a,0x99,0x7d,0x76,0x93,0x94,0xf9,0xee,0x27,0x42,0x4b,0x2e,0xdc,0x30,0x00,0x64,0xe4,0x25,0x00,0x86,0x16,0x6e,0x51,0x41,0x84,0xa4,0x13,0xd1,0x7e,0x87,0xa1,0x04,0xd6,0x75,0xca,0x81,0x61,0x7a,0x8c,0xe0,0x0e,0xab,0xd5,0xcf,0x05,0xbd,0x6e,0x74,0x14,0x56,0x23,0x17,0x43,0x53,0x93,0xcb,0x36,0xc0,0x21,0xfb,0xc6,0x4a,0x69,0x96,0x19,0xe4,0x13,0xf4,0xc9,0x3a,0xfe,0x03,0xfe,0x71,0xbd,0x5c,0x12,0xce,0xc2,0x3c,0x5d,0xc1,0x84,0x39,0xb5,0x76,0x47,0x29,0x89,0x56,0x93,0xb0,0xfa,0x07,0x6b,0x97,0x5f,0x6e,0xe6,0x8f,0xcf,0x3d,0xfb,0xdc,0x1c,0x86,0x81,0xfb,0x6d,0xa7,0x4a,0xcb,0x72,0xc8,0x82,0x08,0xf3,0x8e,0x36,0x4f,0xfa,0xa5,0xf7,0x83,0xad,0x03,0x90,0xc0,0xf8,0x90,0x81,0x34,0x4e,0xa8,0xd6,0x79,0x39,0xce,0xb1,0xf6,0x35,0x38,0x57,0x6d,0xc1,0x56,0x94,0x6d,0x56,0xa3,0xfc,0xab,0x5f,0xdb,0xac,0x6c,0xc2,0x69,0x05,0x3e,0x6a,0xf1,0xb1,0x6e,0x02,0xfd,0x4a,0x7d,0x2b,0x66,0x33,0x9a,0xb5,0xc0,0xc3,0x63,0x4f,0x12,0xe0,0xd4,0x77,0xd7,0x9f,0xeb,0xb6,0x59,0x1a,0x35,0x8b,0x11,0x77,0xa0,0xbe,0x5a,0xa4,0xd0,0xe1,0xfb,0xa8,0x30,0x2f,0x12,0x58,0xcd,0x13,0xde,0x1d,0xeb,0x75,0xf3,0x1a,0x36,0x4b,0x9e,0x38,0xba,0x03,0x3f,0x84,0xa2,0x42,0x14,0xd7,0x6d,0x4b,0xe3,0x5e,0x4b,0x19,0x48,0x21,0x17,0x63,0x10,0x82,0xa1,0x59,0x40,0x8e,0x80,0x2d,0x31,0xae,0x55,0x3a,0x21,0xe9,0xba,0xd6,0x89,0xf6,0x72,0x24,0x03,0xfe,0x0b,0x51,0xf9,0xe1,0x07,0xee,0x8d,0x1e,0x94,0x21,0x2f,0xe6,0xd5,0x4a,0x54,0x86,0x33,0xbd,0x97,0xe5,0x72,0x24,0x0d,0xf6,0x53,0x60,0x37,0xda,0xad,0x23,0x1e,0x93,0xae,0x7f,0x4a,0x63,0x57,0xb7,0x20,0x80,0x74,0x29,0x28,0xa5,0xee,0xb8,0x57,0x0c,0x00,0x1d,0x5b,0xb9,0x70,0x13,0xa6,0xd3,0x0f,0x54,0xed,0x1b,0xf1,0xbf,0xd7,0xe5,0x43,0x16,0xb1,0x91,0xa0,0xe8,0x81,0x8c,0xc2,0xb0,0x8e,0x5b,0xe8,0x8a,0x83,0x1b,0xbf,0x7f,0xe6,0x0c,0xd5,0x7f,0xcf,0x53,0xf5,0x09,0x2f,0xd0,0xfb,0xbd,0x36,0xe3,0xe2,0x1a,0x15,0xbe,0x91,0x12,0xc1,0x11,0xa9,0x76,0x22,0x4b,0xf1,0xcb,0x60,0xe2,0x7c,0xe4,0xa0,0x5e,0xe6,0x46,0xaa,0x67,0xa9,0xed,0x8e,0xab,0x8c,0x1a,0xed,0x6f,0x9e,0x97,0xae,0xf8,0x2c,0x7b,0x7f,0xe2,0xb0,0xfb,0x68,0x50,0xc3,0x90,0xbd,0x92,0x63,0xe9,0x23,0x3e,0x24,0x98,0xc7,0x55,0xfc,0x0a,0x8f,0xf0,0x80,0xc8,0xb7,0x01,0x92,0x06,0x7f,0x09,0xba,0x75,0xdf,0x3b,0xb4,0xce,0x10,0x4e,0x83,0x1a,0x07,0xc6,0xdd,0x42,0xc6,0x7d,0xac,0x4e,0xd4,0x77,0x7d,0x24,0x99,0xf0,0x42,0xd1,0xd9,0xa9,0xea,0x89,0x6b,0x0a,0x10,0x18,0x14,0x08,0xb5,0x94,0x90,0x1d,0x7b,0xd6,0x38,0x50,0x77,0x38,0xcf,0x4b,0x6c,0x24,0xeb,0xf6,0x18,0x2d,0x89,0xab,0x9e,0x44,0x89,0x83,0x7d,0xf2,0x8f,0xf1,0xcc,0x40,0x90,0x8a,0x19,0xec,0xcc,0x8a,0x8f,0x64,0x82,0x10,0x2a,0x08,0xba,0x54,0x7e,0xa4,0xd9,0x4e,0xd2,0x67,0x11,0xf2,0xc6,0x86,0x04,0xab,0x50,0x64,0x01,0x85,0x83,0xb3,0xe0,0x2c,0x83,0x4b,0x34,0x94,0x8f,0x16,0x67,0x49,0xbb,0xf2,0x23,0x9b,0xe3,0xfa,0xee,0x84,0x60,0xf5,0x03,0x36,0x22,0x79,0x95,0x20,0xf8,0x8c,0x1b,0x59,0x8d,0xb4,0xcd,0xcf,0xa3,0x76,0xd5,0x49,0x8c,0xc9,0x73,0xaf,0x6c,0xd4,0xd5,0x76,0x1a,0x82,0xa7,0xc7,0x09,0x49,0x0f,0xb9,0x18,0xbc,0x70,0x88,0xa3,0x2f,0x47,0xe1,0x93,0x14,0xb8,0x79,0xc6,0x28,0x03,0xef,0x82,0x00,0xa3,0x45,0x93,0x38,0x03,0x31,0xa3,0xb4,0x15,0x8e,0x87,0xd5,0x26,0x9b,0x8f,0xae,0x86,0x44,0x44,0xd9,0xce,0xd5,0x64,0x77,0x6b,0xa0,0x98,0x08,0xab,0xf7,0x06,0xff,0x3a,0xc1,0x9c,0x84,0x06,0xe9,0xdd,0x7a,0x2b,0xa7,0x40,0x01,0x1b,0x10,0x63};


/******************************************************************************
 *
 * @brief   Main function
 *  - Initializes the MCU
 *  - Selects whether to run application or bootloader
 *  - If bootloader:
 *      - Initializes the peripheral interface
 *      - Waits for a command
 *      - Sends the corresponding response
 *  - If application:
 *      - Jump to application
 *
 * @return  none
 *****************************************************************************/
const uint8_t fkey[16] = {
            0x2b, 0x7e, 0x15, 0x16, 0x28, 0xae, 0xd2, 0xa6,
            0xab, 0xf7, 0x15, 0x88, 0x09, 0xcf, 0x4f, 0x3c
        };
static uint8_t Tag[16];
int main(void)
{
    HW_init();
    WISP_init();

    struct tc_cmac_struct c;// c;
    __no_operation();
    P1OUT |= BIT4;
    __no_operation();
    P1OUT &= ~BIT4;
    P1OUT |= BIT4;
    __no_operation();
    tc_cmac_AIO(&c,fkey,msg,1536,Tag);
    P1OUT &= ~BIT4;
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    P1OUT |= BIT4;
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    __no_operation();
    P1OUT &= ~BIT4;
    while(FOREVER){
        __no_operation();
        __no_operation();
        __no_operation();
        __no_operation();
        __no_operation();
        __no_operation();
        __no_operation();
        __no_operation();
        __no_operation();
        __no_operation();
    }
}


/******************************************************************************
 *
 * @brief   Initializes the basic MCU HW
 *
 * @return  none
 *****************************************************************************/
static void HW_init(void)
{
    WDTCTL = WDTPW | WDTHOLD;   // Stop watchdog timer


//    P3OUT |= BIT4;
//    P3DIR |= BIT4;// mark the Tactive start.
    P1DIR |= BIT4;
    P1OUT &= ~BIT4;
    // Just initialize S2 button to force BSL mode
//    P1OUT |= BIT1;
//    P1REN |= BIT1;
    PM5CTL0 &= ~LOCKLPM5;       // Lock LPM5.
}

/******************************************************************************
 *
 * @brief   Initializes the Memory Protection Unit of FR5969
 *          This allows for HW protection of Bootloader area
 *
 * @return  none
 *****************************************************************************/
static void MPU_init(void)
{
    // These calculations work for FR5969 (check user guide for MPUSEG values)
    //  Border 1 = Start of bootloader
    //  Border 2 = 0x10000
    //  Segment 1 = 0x4400 - Bootloader
    //  Segment 2 = Bootloader - 0xFFFF
    //  Segment 3 = 0x10000 - 0x23FFF
    //  Segment 2 is write protected and generates a PUC

    MPUCTL0 = MPUPW;                        // Write PWD to access MPU registers
    MPUSEGB1 = (BOOT_START_ADDR) >> 4;      // B1 = Start of Boot; B2 = 0x10000
    MPUSEGB2 = (0x10000) >> 4;
    MPUSAM &= ~MPUSEG2WE;                   // Segment 2 is protected from write
    MPUSAM |= MPUSEG2VS;                     // Violation select on write access
    MPUCTL0 = MPUPW | MPUENA;                 // Enable MPU protection
    MPUCTL0_H = 0x00;                         // Disable access to MPU registers
}
